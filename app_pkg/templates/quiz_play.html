

{% extends "base.html" %}
{% block content %}
    <head>
        <title>Quiz Play Room</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.2/socket.io.js"></script>
        <script type="text/javascript">
            // socket handler
            let socket = io.connect("http://localhost:5000");
            let abcd = ['A', 'B', 'C', 'D'];

            $(document).ready(function () {
                socket.on('connect', function () {
                    socket.send("User connected!");
                });

                socket.on('message', function (data) {
                    if (data.includes('<')) {
                        if ("{{ current_user.type }}" === "student") {
                            $('#on_going_question').empty().append(data).remove($('#nextBtn'));
                        }
                    } else if ("{{ current_user.type }}" === "lecturer") {
                        $('#players').append($('<p>').text(data));
                    }
                });

                $('#startBtn').on('click', function () {
                    $('#waiting').hide();
                    showQuestion();
                    socket.send(document.getElementById("on_going_question").innerHTML.toString());
                    let choices = document.getElementsByClassName("choices")[0].querySelectorAll(".choice");
                    for (let i = 0; i < choices.length; i++) {
                        choices[i].setAttribute("onclick", '');
                    }
                    document.getElementById("on_going_question").innerHTML +=
                        '<input type="button" value="Next" id="nextBtn" onclick="nextQuestion()"/>';
                });
            });

            // question setup
            // add prev and next method to array type
            Array.prototype.next = function () {
                return this[++this.current];
            };
            Array.prototype.prev = function () {
                return this[--this.current];
            };
            Array.prototype.current = 0;

            let questions = {{ the_quiz|safe }};
            let current_question = JSON.parse(JSON.stringify(questions[questions.current]));
            let answer;
            let student_answers = {"quiz_id": {{quiz_id}}};

            function showQuestion() {
                let question = '<div>Question: <span id="question"></span></div>';
                question += '<div class="choices">';
                for (let i = 0; i < 4; i++) {
                    question += '<input class="choice" id="' + abcd[i] + '"' + '/>&emsp;';
                }
                question += '</div>';
                document.getElementById("on_going_question").innerHTML = question;
                let choices = document.getElementsByClassName("choices")[0].querySelectorAll(".choice");
                // set onclick attribute to all available options
                for (let i = 0; i < choices.length; i++) {
                    choices[i].setAttribute("onclick", 'choicePicked("' + abcd[i] + '")');
                    choices[i].setAttribute("type", "button");
                    choices[i].setAttribute("value", "");
                }
                // set question content
                answer = current_question.answer;
                document.getElementById('question').innerHTML = current_question.question;
                document.getElementById('A').value = current_question.choice_a;
                document.getElementById('B').value = current_question.choice_b;
                document.getElementById('C').value = current_question.choice_c;
                document.getElementById('D').value = current_question.choice_d;
                // document.getElementById(answer).setAttribute("class", "answer");
            }

            function choicePicked(choice) {
                console.log(socket.emit("get current question"));
                if (choice === answer) {
                    student_answers[current_question.id] = true;
                    document.getElementById(answer).setAttribute("class", "answer");
                } else {
                    student_answers[current_question.id] = false;
                    document.getElementById(choice).setAttribute("class", "wrong");
                }
            }

            function nextQuestion() {
                if (!!questions.next()) {
                    current_question = JSON.parse(JSON.stringify(questions.next()));
                    document.getElementById(answer).removeAttribute("class");
                    showQuestion();
                    socket.send(document.getElementById("on_going_question").innerHTML.toString());
                    let choices = document.getElementsByClassName("choices")[0].querySelectorAll(".choice");
                    for (let i = 0; i < choices.length; i++) {
                        choices[i].setAttribute("onclick", '');
                    }
                    document.getElementById("on_going_question").innerHTML +=
                        '<input type="button" value="Next" id="nextBtn" onclick="nextQuestion()"/>';
                } else {
                    fetch(`/send_quiz_result`, {
                        method: "POST",
                        credentials: "include",
                        body: JSON.stringify(student_answers),
                        cache: "no-cache",
                        headers: new Headers({
                            "content-type": "application/json"
                        })
                    })
                    document.getElementById("on_going_question").innerHTML = "<h1>Quiz Finished!</h1>";
                    socket.send(document.getElementById("on_going_question").innerHTML.toString());
                }
            }

            $(window).on('load', function () {
                if ("{{ current_user.type }}" === "lecturer") {
                    $('#players').append($('<p>').text("Yeah-oo! Lecturer {{ current_user.username }} has initiated the game!"));
                } else {
                    $('#startBtn').hide();
                    socket.send("Kaboom!!! Student {{ current_user.username }} has joined the game!\r");
                }
            });
        </script>
    </head>
    <div id="on_going_question">
        <button id="startBtn">Let's Go!!!</button>
        {% if current_user.type == "lecturer" %}
            <h3 id="quizPIN">The Game PIN: {{ PIN }}</h3>
            <div id="players"><p>Players:</p></div>
        {% else %}
            <p>quiz_play for the lecturer to start...</p>
        {% endif %}
    </div>
{% endblock %}