{% extends "base.html" %}
{% block content %}
    <head>
        <title>In Quiz Game</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.2/socket.io.js"
                type="text/javascript"></script>
        <script type="text/javascript">
            // add prev and next method to array type
            Array.prototype.next = function () {
                return this[++this.current];
            };
            Array.prototype.prev = function () {
                return this[--this.current];
            };
            Array.prototype.current = 0;

            let questions = {{ the_quiz|safe }};
            let current_question = JSON.parse(JSON.stringify(questions[questions.current]));
            let answer;
            let student_answer = {"quiz_id": {{quiz_id}}};

            function showQuestion() {
                answer = current_question.answer;
                document.getElementById('question').innerHTML = current_question.question;
                document.getElementById('A').value = current_question.choice_a;
                document.getElementById('B').value = current_question.choice_b;
                document.getElementById('C').value = current_question.choice_c;
                document.getElementById('D').value = current_question.choice_d;
                if ('{{ current_user.type }}' === "lecturer") {
                    document.getElementById(answer).setAttribute("class", "answer");
                }
            }

            function handler(e) {
                e.stopPropagation();
                e.preventDefault();
            }

            function choicePicked(choice) {
                if (choice === answer) {
                    student_answer[current_question.id] = true;
                    {#document.getElementById(answer).setAttribute("class", "answer");#}
                } else {
                    student_answer[current_question.id] = false;
                    {#document.getElementById(choice).setAttribute("class", "wrong");#}
                }
                nextQuestion();
                {#document.addEventListener("click", handler, true);#}
            }

            function nextQuestion() {
                if (!!questions.next()) {
                    current_question = JSON.parse(JSON.stringify(questions.next()));
                    document.getElementById(answer).removeAttribute("class");
                    showQuestion();
                } else {
                    fetch(`/send_quiz_result`, {
                        method: "POST",
                        credentials: "include",
                        body: JSON.stringify(student_answer),
                        cache: "no-cache",
                        headers: new Headers({
                            "content-type": "application/json"
                        })
                    })
                    document.getElementById("taking_quiz").innerHTML = "<h1>Quiz Finished!</h1>";
                }
            }

            window.onload = function () {
                showQuestion();
            };
        </script>
    </head>
    <div id="taking_quiz">
        {% if current_user.type == "lecturer" %}
            <div class="question_title">Question: <span id="question"></span></div>
            <input type="button" value="Next" id="add-btn" onclick="nextQuestion()"/><br><br><br><br><br>
            <div class="choices">
                <input type="button" id="A" value="" onclick=""/>&emsp;
                <input type="button" id="B" value="" onclick=""/><br>
                <input type="button" id="C" value="" onclick=""/>&emsp;
                <input type="button" id="D" value="" onclick=""/>
            </div>
        {% else %}
            <div>Question: <span id="question"></span></div>
            <div class="choices">
                <input type="button" id="A" value="" onclick="choicePicked('A')"/>&emsp;
                <input type="button" id="B" value="" onclick="choicePicked('B')"/><br>
                <input type="button" id="C" value="" onclick="choicePicked('C')"/>&emsp;
                <input type="button" id="D" value="" onclick="choicePicked('D')"/>
            </div>
        {% endif %}
    </div>
{% endblock %}